<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive Gallery</title>
    
    <!-- Tailwind CSS (スタイリング用) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UI構築用) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (ブラウザでのJSX実行用) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* スクロールバー非表示用ユーティリティ */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body {
            margin: 0;
            background-color: #171717; /* neutral-900 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- アイコンコンポーネント (SVG) ---
        const ChevronLeft = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="15 18 9 12 15 6"></polyline></svg>
        );
        const ChevronRight = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 18 15 12 9 6"></polyline></svg>
        );
        const Maximize2 = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
        );
        const X = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        );
        const Loader2 = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
        );
        const AlertCircle = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
        );

        // --- 設定エリア ---------------------------------------------

        // 1. GoogleスプレッドシートのID設定
        // URLパラメータ "id" で指定できるように変更しました。
        // 例: gallery.html?id=YOUR_SHEET_ID
        // 指定がない場合は以下のデフォルトIDが使用されます。
        const DEFAULT_SHEET_ID = "";

        // URLパラメータからIDを取得するロジック
        const getSheetId = () => {
            if (typeof window !== 'undefined') {
                const params = new URLSearchParams(window.location.search);
                const urlId = params.get('id');
                if (urlId) return urlId;
            }
            return DEFAULT_SHEET_ID;
        };

        const GOOGLE_SHEET_ID = getSheetId();

        // デモ用データ
        const DEMO_IMAGES = [
            {
                id: "demo_1",
                title: "Mountain View (Demo)",
                demoUrl: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?q=80&w=2070&auto=format&fit=crop"
            },
            {
                id: "demo_2",
                title: "Ocean Sunset (Demo)",
                demoUrl: "https://images.unsplash.com/photo-1475924156734-496f6cac6ec1?q=80&w=2070&auto=format&fit=crop"
            },
            {
                id: "demo_3",
                title: "Forest Path (Demo)",
                demoUrl: "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2070&auto=format&fit=crop"
            }
        ];

        // 画像URL生成ヘルパー
        // IDが通常のURLの場合はそのまま返し、そうでない場合はGoogle Drive IDとして処理
        const getImageUrl = (idOrUrl, demoUrl) => {
            if (!idOrUrl) return '';
            
            // デモモード
            if (idOrUrl.startsWith("demo_") && demoUrl) return demoUrl;
            
            // 入力が通常のURL (http/https) の場合はそのまま返す
            if (idOrUrl.startsWith('http://') || idOrUrl.startsWith('https://')) {
                return idOrUrl;
            }
            
            // 以下、Google Drive IDとしての処理
            let cleanId = idOrUrl;
            // URL形式のDriveリンクからIDを抽出
            if (idOrUrl.includes('id=')) {
                cleanId = idOrUrl.split('id=')[1].split('&')[0];
            } else if (idOrUrl.includes('/d/')) {
                cleanId = idOrUrl.split('/d/')[1].split('/')[0];
            }

            // Google Driveの画像表示用URLを返す
            return `https://lh3.googleusercontent.com/d/${cleanId}`;
        };

        // --- メインコンポーネント ---------------------------------------------
        function App() {
            const [images, setImages] = useState(DEMO_IMAGES);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isFullscreen, setIsFullscreen] = useState(false);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const thumbContainerRef = useRef(null);

            useEffect(() => {
                const fetchSheetData = async () => {
                    // IDが無効、またはデフォルトのプレースホルダー値の場合
                    if (!GOOGLE_SHEET_ID || GOOGLE_SHEET_ID === "YOUR_SPREADSHEET_ID_HERE") {
                        setLoading(false);
                        return;
                    }

                    try {
                        setLoading(true);
                        const response = await fetch(
                            `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/export?format=csv`
                        );
                        
                        if (!response.ok) {
                            throw new Error("スプレッドシートの読み込みに失敗しました。「ウェブに公開」設定を確認してください。");
                        }

                        const csvText = await response.text();
                        const rows = csvText.split('\n').map(row => row.split(','));

                        const parsedImages = rows.slice(1)
                            .filter(row => row[0] && row[0].trim() !== '')
                            .map((row, index) => ({
                                id: row[0].trim(), // A列: ID または URL
                                title: row[1] ? row[1].trim() : `Image ${index + 1}`, // B列: タイトル
                                demoUrl: null
                            }));

                        if (parsedImages.length > 0) {
                            setImages(parsedImages);
                            setError(null);
                        } else {
                            setError("スプレッドシートにデータが見つかりませんでした。");
                        }
                    } catch (err) {
                        console.error(err);
                        setError("データの読み込みエラー: スプレッドシートIDまたは公開設定を確認してください。");
                    } finally {
                        setLoading(false);
                    }
                };

                fetchSheetData();
            }, []);

            const nextSlide = () => {
                setCurrentIndex((prev) => (prev === images.length - 1 ? 0 : prev + 1));
            };

            const prevSlide = () => {
                setCurrentIndex((prev) => (prev === 0 ? images.length - 1 : prev - 1));
            };

            const selectSlide = (index) => {
                setCurrentIndex(index);
            };

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'ArrowRight') nextSlide();
                    if (e.key === 'ArrowLeft') prevSlide();
                    if (e.key === 'Escape') setIsFullscreen(false);
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [images.length]);

            useEffect(() => {
                if (thumbContainerRef.current) {
                    const activeThumb = thumbContainerRef.current.children[currentIndex];
                    if (activeThumb) {
                        activeThumb.scrollIntoView({
                            behavior: 'smooth',
                            block: 'nearest',
                            inline: 'center',
                        });
                    }
                }
            }, [currentIndex]);

            const currentImage = images[currentIndex];

            return (
                <div className={`w-full bg-neutral-900 flex flex-col ${isFullscreen ? 'fixed inset-0 z-50 h-[100dvh]' : 'h-[100dvh] md:h-screen md:max-h-[800px]'}`}>
                    
                    {/* メインスライダーエリア */}
                    <div className="relative flex-1 bg-black overflow-hidden group">
                        
                        {/* ローディング */}
                        {loading && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center text-white bg-black/50 z-20">
                                <Loader2 className="animate-spin mb-2" size={32} />
                                <p>Loading gallery...</p>
                            </div>
                        )}

                        {/* エラー */}
                        {error && GOOGLE_SHEET_ID !== "YOUR_SPREADSHEET_ID_HERE" && (
                            <div className="absolute top-0 left-0 right-0 bg-red-600/80 text-white p-2 text-xs flex items-center justify-center gap-2 z-30">
                                <AlertCircle size={14} />
                                {error} (デモデータを表示中)
                            </div>
                        )}

                        {/* 画像 */}
                        <div className="absolute inset-0 flex items-center justify-center p-0 md:p-2">
                            {currentImage && (
                                <img
                                    src={getImageUrl(currentImage.id, currentImage.demoUrl)}
                                    alt={currentImage.title}
                                    className="max-w-full max-h-full object-contain transition-opacity duration-300 select-none shadow-lg"
                                />
                            )}
                        </div>

                        {/* ナビゲーション - モバイルでは常時表示、PCではホバー時表示 */}
                        <button onClick={prevSlide} className="absolute left-2 top-1/2 -translate-y-1/2 bg-black/20 hover:bg-black/70 text-white p-2 rounded-full backdrop-blur-sm transition-all opacity-100 md:opacity-0 md:group-hover:opacity-100 focus:opacity-100 z-10" aria-label="Previous slide">
                            <ChevronLeft size={32} />
                        </button>
                        
                        <button onClick={nextSlide} className="absolute right-2 top-1/2 -translate-y-1/2 bg-black/20 hover:bg-black/70 text-white p-2 rounded-full backdrop-blur-sm transition-all opacity-100 md:opacity-0 md:group-hover:opacity-100 focus:opacity-100 z-10" aria-label="Next slide">
                            <ChevronRight size={32} />
                        </button>

                        {/* ツールバー */}
                        <div className="absolute top-4 right-4 flex gap-2 z-10">
                            <button onClick={() => setIsFullscreen(!isFullscreen)} className="bg-black/40 hover:bg-black/70 text-white p-2 rounded-full backdrop-blur-sm transition-colors" aria-label="Toggle fullscreen">
                                {isFullscreen ? <X size={20} /> : <Maximize2 size={20} />}
                            </button>
                        </div>

                        {/* キャプション - モバイルでは少し文字を小さく */}
                        <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4 md:p-6 pt-12 pointer-events-none">
                            <h2 className="text-white text-base md:text-lg font-medium tracking-wide truncate pr-12">
                                {currentImage?.title || 'No Title'}
                            </h2>
                            <p className="text-gray-300 text-xs md:text-sm">
                                {currentIndex + 1} / {images.length}
                            </p>
                        </div>
                    </div>

                    {/* サムネイル - モバイルでは少し小さく */}
                    <div className="h-20 md:h-24 bg-neutral-900 border-t border-neutral-800 flex-shrink-0">
                        <div ref={thumbContainerRef} className="h-full flex items-center gap-2 px-2 md:px-4 overflow-x-auto scrollbar-hide" style={{ scrollBehavior: 'smooth' }}>
                            {images.map((img, idx) => {
                                const isActive = idx === currentIndex;
                                return (
                                    <button
                                        key={idx}
                                        onClick={() => selectSlide(idx)}
                                        className={`relative flex-shrink-0 h-14 w-20 md:h-16 md:w-24 rounded overflow-hidden transition-all duration-300 ${isActive ? 'ring-2 ring-blue-500 opacity-100 scale-105' : 'opacity-50 hover:opacity-80'}`}
                                    >
                                        <img
                                            src={getImageUrl(img.id, img.demoUrl)}
                                            alt={`Thumbnail ${idx + 1}`}
                                            className="w-full h-full object-cover"
                                        />
                                        {!isActive && <div className="absolute inset-0 bg-black/20" />}
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
